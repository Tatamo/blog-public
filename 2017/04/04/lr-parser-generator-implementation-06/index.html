<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="robots" content="index,follow">
    <meta name="description" content="Tatamo&#39;s weblog">
    <meta name="author" content="Tatamo">
    <meta name="viewport" content="width=device-width">
    
    <base href="http://tatamo.81.la/blog/">
    <title>
      LR(1)パーサジェネレータを自作して構文解析をする 第6回:パーサの実装と構文解析の実行 | わたしろぐ
    </title>
    <link rel="stylesheet" type="text/css" href="css/style.css" media="all">
    <link rel="canonical" href="http://tatamo.81.la/blog/2017/04/04/lr-parser-generator-implementation-06/">
    <link rel="stylesheet" href="highlight/styles/default.css">
    <script src="highlight/highlight.pack.js"></script>
    <script>
    
    window.addEventListener("DOMContentLoaded", () => {
        const elements = document.getElementsByTagName("code");
        for (const el of elements) {
            if (el.parentNode.tagName != "PRE") {
                
                el.style.display = "inline";
                el.style.margin = "0 2px";
                el.style.padding = "1px 3px";
                if (el.classList.length == 0) {
                    
                    el.classList.add("nohighlight");
                }
            }
            hljs.highlightBlock(el);
			
            if (el.classList.contains("nohighlight") ||
                el.classList.contains("lang-nohighlight") ||
                el.classList.contains("language-nohighlight")) {
                el.classList.add("hljs");
            }
        }
    }, false);
    </script>
    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-71305633-1', 'auto');
    ga('send', 'pageview');
    </script>
</head>
<body>
    <header>
        <h1 class="site-title"><a href="http://tatamo.81.la/blog/">わたしろぐ</a></h1>
        <h2 class="site-subtitle">私録</h2>
    </header>
    <nav class="head-nav">
        <ul>
        <li><a href="about/">about</a></li>
        <li><a href="https://twitter.com/__tatamo__" target="_blank">twitter</a></li>
        <li><a href="https://github.com/tatamo" target="_blank">github</a></li>
        </ul>
    </nav>
    <div class="container">
    <div class="main-content">

    <article class="article">
        <h1 class="article-title"><a href="http://tatamo.81.la/blog/2017/04/04/lr-parser-generator-implementation-06/">LR(1)パーサジェネレータを自作して構文解析をする 第6回:パーサの実装と構文解析の実行</a></h1>
        <span class="article-datetime"><time>2017-04-04 23:41:09</time></span>
        <p class="article-categories">Category:
        <a href="http://tatamo.81.la/blog/categories/dev/">dev</a></p>
        <p class="article-tags">Tag:
        <a href="http://tatamo.81.la/blog/tags/parsing/">parsing</a>
        <a href="http://tatamo.81.la/blog/tags/parser-generator/">parser generator</a>
        <a href="http://tatamo.81.la/blog/tags/parser/">parser</a>
        <a href="http://tatamo.81.la/blog/tags/lexer/">lexer</a></p>
        <p><a href="http://tatamo.81.la/blog/2017/04/04/lr-parser-generator-implementation-05/">前回</a>ではLR(1)法による構文解析表の実装を済ませました。
今回はいよいよ、構文解析表をもとに実際に構文解析を行うことのできる構文解析器を実装し、実際に構文解析を行ってみます。</p>
<p>概略は<a href="http://tatamo.81.la/blog/2017/03/22/lr-parser-generator-implementation-04/">第4回</a>で示した通りであり、ステートマシンの仕様に沿って構文解析表を解析できるようにします。
第4回でアルゴリズム面まで踏み込んで解説してしまったため、あまり書くことがなくてやや後悔しています。</p>
<h2 id="astの定義">ASTの定義</h2>
<p>パーサを実装する前に、パーサの出力結果となる抽象構文木の定義を行います。 <br>
<a href="https://github.com/Tatamo/parsergenerator/blob/master/src/parser/ast.ts">https://github.com/Tatamo/parsergenerator/blob/master/src/parser/ast.ts</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#75715e">/// ast.ts
</span><span style="color:#75715e"></span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">ASTNode</span>{
	<span style="color:#a6e22e">type</span>: <span style="color:#66d9ef">Token</span>;
	<span style="color:#a6e22e">value</span>: <span style="color:#66d9ef">string</span><span style="color:#f92672">|</span><span style="color:#66d9ef">null</span>;
	<span style="color:#a6e22e">children</span>: <span style="color:#66d9ef">Array</span>&lt;<span style="color:#f92672">ASTNode</span>&gt;;
}
</code></pre></div><p>構文木は再帰的な木構造によって表されます。
それぞれのノードにはそれが何の記号かを示すトークン、およびそのトークンに紐つけられている実際の入力文字列(そのトークンが非終端記号である場合はnull)、自身の子となるノードの配列を持ちます。</p>
<p>たとえば、<a href="http://tatamo.81.la/blog/2017/03/21/lr-parser-generator-implementation-03/">第3回</a>で定義した構文規則によって<code>1+1</code>を解析した場合、結果として得られる抽象構文木は以下のようになるでしょう。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{<span style="color:#f92672">&#34;type&#34;</span>:<span style="color:#e6db74">&#34;EXP&#34;</span>, <span style="color:#f92672">&#34;value&#34;</span>:<span style="color:#66d9ef">null</span>, <span style="color:#f92672">&#34;children&#34;</span>:[
    {<span style="color:#f92672">&#34;type&#34;</span>:<span style="color:#e6db74">&#34;EXP&#34;</span>, <span style="color:#f92672">&#34;value&#34;</span>:<span style="color:#66d9ef">null</span>, <span style="color:#f92672">&#34;children&#34;</span>:[
        {<span style="color:#f92672">&#34;type&#34;</span>:<span style="color:#e6db74">&#34;TERM&#34;</span>, <span style="color:#f92672">&#34;value&#34;</span>:<span style="color:#66d9ef">null</span>, <span style="color:#f92672">&#34;children&#34;</span>:[
            {<span style="color:#f92672">&#34;type&#34;</span>:<span style="color:#e6db74">&#34;ATOM&#34;</span>, <span style="color:#f92672">&#34;value&#34;</span>:<span style="color:#66d9ef">null</span>, <span style="color:#f92672">&#34;children&#34;</span>:[
                {<span style="color:#f92672">&#34;type&#34;</span>:<span style="color:#e6db74">&#34;DIGITS&#34;</span>, <span style="color:#f92672">&#34;value&#34;</span>:<span style="color:#e6db74">&#34;1&#34;</span>, <span style="color:#f92672">&#34;children&#34;</span>:[]}
            ]}
        ]}
    ]}, 
    {<span style="color:#f92672">&#34;type&#34;</span>:<span style="color:#e6db74">&#34;PLUS&#34;</span>, <span style="color:#f92672">&#34;value&#34;</span>:<span style="color:#e6db74">&#34;+&#34;</span>, <span style="color:#f92672">&#34;children&#34;</span>:[]}, 
    {<span style="color:#f92672">&#34;type&#34;</span>:<span style="color:#e6db74">&#34;TERM&#34;</span>, <span style="color:#f92672">&#34;value&#34;</span>:<span style="color:#66d9ef">null</span>, <span style="color:#f92672">&#34;children&#34;</span>:[
        {<span style="color:#f92672">&#34;type&#34;</span>:<span style="color:#e6db74">&#34;ATOM&#34;</span>, <span style="color:#f92672">&#34;value&#34;</span>:<span style="color:#66d9ef">null</span>, <span style="color:#f92672">&#34;children&#34;</span>:[
            {<span style="color:#f92672">&#34;type&#34;</span>:<span style="color:#e6db74">&#34;DIGITS&#34;</span>, <span style="color:#f92672">&#34;value&#34;</span>:<span style="color:#e6db74">&#34;1&#34;</span>, <span style="color:#f92672">&#34;children&#34;</span>:[]}
        ]}
    ]}
]}

</code></pre></div><p>簡単ですね。</p>
<h2 id="パーサの実装">パーサの実装</h2>
<p>ではParserクラスを作っていきます。 <br>
<a href="https://github.com/Tatamo/parsergenerator/blob/master/src/parser/parser.ts">https://github.com/Tatamo/parsergenerator/blob/master/src/parser/parser.ts</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#75715e">/// parser.ts
</span><span style="color:#75715e"></span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">TerminalCallbackArg</span> {
        <span style="color:#a6e22e">token</span>: <span style="color:#66d9ef">string</span>;
        <span style="color:#a6e22e">value</span>: <span style="color:#66d9ef">string</span>;
        <span style="color:#a6e22e">terminal</span>: <span style="color:#66d9ef">true</span>;
}
<span style="color:#66d9ef">export</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">NonterminalCallbackArg</span> {
        <span style="color:#a6e22e">token</span>: <span style="color:#66d9ef">string</span>;
        <span style="color:#a6e22e">children</span>: <span style="color:#66d9ef">Array</span>&lt;<span style="color:#f92672">any</span>&gt;;
        <span style="color:#a6e22e">pattern</span>: <span style="color:#66d9ef">Array</span>&lt;<span style="color:#f92672">string</span>&gt;;
        <span style="color:#a6e22e">terminal</span>: <span style="color:#66d9ef">false</span>;
}
<span style="color:#66d9ef">export</span> <span style="color:#66d9ef">declare</span> <span style="color:#a6e22e">type</span> <span style="color:#a6e22e">ParserCallbackArg</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">TerminalCallbackArg</span> <span style="color:#f92672">|</span> <span style="color:#a6e22e">NonterminalCallbackArg</span>;
<span style="color:#66d9ef">export</span> <span style="color:#66d9ef">declare</span> <span style="color:#a6e22e">type</span> <span style="color:#a6e22e">ParserCallback</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">arg</span>: <span style="color:#66d9ef">ParserCallbackArg</span>) <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">any</span>;
<span style="color:#66d9ef">export</span> <span style="color:#66d9ef">declare</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Parser</span> {
        <span style="color:#66d9ef">private</span> <span style="color:#a6e22e">lexer</span>;
        <span style="color:#66d9ef">private</span> <span style="color:#a6e22e">syntax</span>;
        <span style="color:#66d9ef">private</span> <span style="color:#a6e22e">parsingtable</span>;
        <span style="color:#66d9ef">private</span> <span style="color:#a6e22e">default_callback</span>;
        <span style="color:#66d9ef">constructor</span>(<span style="color:#a6e22e">lexer</span>: <span style="color:#66d9ef">ILexer</span>, <span style="color:#a6e22e">syntax</span>: <span style="color:#66d9ef">SyntaxDefinitions</span>, <span style="color:#a6e22e">parsingtable</span>: <span style="color:#66d9ef">ParsingTable</span>, <span style="color:#a6e22e">default_callback?</span>: <span style="color:#66d9ef">ParserCallback</span> <span style="color:#f92672">|</span> <span style="color:#66d9ef">null</span>);
        <span style="color:#a6e22e">setDefaultCallback</span>(<span style="color:#a6e22e">default_callback?</span>: <span style="color:#66d9ef">ParserCallback</span> <span style="color:#f92672">|</span> <span style="color:#66d9ef">null</span>)<span style="color:#f92672">:</span> <span style="color:#66d9ef">void</span>;
        <span style="color:#a6e22e">parse</span>(<span style="color:#a6e22e">input</span>: <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">cb?</span>: <span style="color:#66d9ef">ParserCallback</span>)<span style="color:#f92672">:</span> <span style="color:#a6e22e">any</span>;
        <span style="color:#66d9ef">private</span> <span style="color:#a6e22e">_parse</span>(<span style="color:#a6e22e">inputs</span>, <span style="color:#a6e22e">cb</span><span style="color:#f92672">?</span>);
}
</code></pre></div><p>できました。</p>
<p>構文解析処理を行う処理は、110行程度に及ぶ<a href="https://github.com/Tatamo/parsergenerator/blob/master/src/parser/parser.ts#L40">Parser#_parse()メソッド</a>の内部で完結しています。
これは、<a href="http://tatamo.81.la/blog/2017/03/22/lr-parser-generator-implementation-04/">第4回</a>に示したオートマトンの動作を仕様通りに実装しています。
入力を前から順に読み込み、現在スタックに積まれている状態番号を取得し、構文解析表の該当する位置に書かれている命令を実行していくだけです。</p>
<p>ここでは、構文解析の実行中に衝突した命令が存在した場合、その時点で解析失敗としてエラーを返すようにしています。
コンフリクトが発生した際の対処についても<a href="http://tatamo.81.la/blog/2017/03/22/lr-parser-generator-implementation-04/">第4回</a>で触れていますが、一般に使用されているパーサジェネレータでは、構文規則を定義するファイルの中に演算子の優先度や右結合/左結合の指定を行うことができたり、指定のない場合はshift/reduceのいずれかを優先するようになっていたりします。</p>
<p>このあたりのコンフリクト回避処理や、エラーが発生した際の詳細なエラー情報の検知・回避などの機能面には大きく改善の余地があります。</p>
<p>あとは、このParserをParserGeneratorから利用できるようにするため、適当にファクトリクラスを作ります。
<a href="https://github.com/Tatamo/parsergenerator/blob/master/src/parser/factory.ts">https://github.com/Tatamo/parsergenerator/blob/master/src/parser/factory.ts</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#75715e">/// factory.ts
</span><span style="color:#75715e"></span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ParserFactory</span>{
	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#a6e22e">create</span>(<span style="color:#a6e22e">grammar</span>: <span style="color:#66d9ef">GrammarDefinition</span>, <span style="color:#a6e22e">parsing_table</span>: <span style="color:#66d9ef">ParsingTable</span>, <span style="color:#a6e22e">default_fallback?</span>: <span style="color:#66d9ef">ParserCallback</span>)<span style="color:#f92672">:</span><span style="color:#a6e22e">Parser</span>{
		<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">lexer</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Lexer</span>(<span style="color:#a6e22e">grammar</span>.<span style="color:#a6e22e">lex</span>);
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Parser</span>(<span style="color:#a6e22e">lexer</span>, <span style="color:#a6e22e">grammar</span>.<span style="color:#a6e22e">syntax</span>, <span style="color:#a6e22e">parsing_table</span>, <span style="color:#a6e22e">default_fallback</span>);
	}
}
</code></pre></div><p><a href="https://github.com/Tatamo/parsergenerator/blob/master/src/parsergenerator/parsergenerator.ts#L32">ParserGenerator#getParser()メソッド</a>には、以下のような記述を行います。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#75715e">/// parsergenerator.ts
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#a6e22e">getParser</span>(<span style="color:#a6e22e">default_callback?</span>: <span style="color:#66d9ef">ParserCallback</span>)<span style="color:#f92672">:</span><span style="color:#a6e22e">Parser</span>{
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ParserFactory</span>.<span style="color:#a6e22e">create</span>(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">grammar</span>, <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">parsing_table</span>, <span style="color:#a6e22e">default_callback</span>);
}
</code></pre></div><p>これで完成です。</p>
<h2 id="構文解析を実行する">構文解析を実行する</h2>
<h3 id="構文木を生成する">構文木を生成する</h3>
<p>では、実際に構文解析を実行してみましょう。
与える構文は、以下のようになります。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">syntax</span>:<span style="color:#66d9ef">SyntaxDefinitions</span> <span style="color:#f92672">=</span> [
	{
		<span style="color:#a6e22e">ltoken</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;EXP&#34;</span>,
		<span style="color:#a6e22e">pattern</span><span style="color:#f92672">:</span> [<span style="color:#e6db74">&#34;EXP&#34;</span>, <span style="color:#e6db74">&#34;PLUS&#34;</span>, <span style="color:#e6db74">&#34;TERM&#34;</span>]
	},
	{
		<span style="color:#a6e22e">ltoken</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;EXP&#34;</span>,
		<span style="color:#a6e22e">pattern</span><span style="color:#f92672">:</span> [<span style="color:#e6db74">&#34;TERM&#34;</span>]
	},
	{
		<span style="color:#a6e22e">ltoken</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;TERM&#34;</span>,
		<span style="color:#a6e22e">pattern</span><span style="color:#f92672">:</span> [<span style="color:#e6db74">&#34;TERM&#34;</span>, <span style="color:#e6db74">&#34;ASTERISK&#34;</span>, <span style="color:#e6db74">&#34;ATOM&#34;</span>]
	},
	{
		<span style="color:#a6e22e">ltoken</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;TERM&#34;</span>,
		<span style="color:#a6e22e">pattern</span><span style="color:#f92672">:</span> [<span style="color:#e6db74">&#34;ATOM&#34;</span>]
	},
	{
		<span style="color:#a6e22e">ltoken</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;ATOM&#34;</span>,
		<span style="color:#a6e22e">pattern</span><span style="color:#f92672">:</span>[<span style="color:#e6db74">&#34;DIGITS&#34;</span>]
	},
	{
		<span style="color:#a6e22e">ltoken</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;ATOM&#34;</span>,
		<span style="color:#a6e22e">pattern</span><span style="color:#f92672">:</span>[<span style="color:#e6db74">&#34;LPAREN&#34;</span>, <span style="color:#e6db74">&#34;EXP&#34;</span>, <span style="color:#e6db74">&#34;RPAREN&#34;</span>]
	}
];
<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">lex</span>:<span style="color:#66d9ef">LexDefinitions</span> <span style="color:#f92672">=</span> [
	{<span style="color:#a6e22e">token</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;DIGITS&#34;</span>, <span style="color:#a6e22e">pattern</span><span style="color:#f92672">:</span><span style="color:#e6db74">/[1-9][0-9]*/</span>},
	{<span style="color:#a6e22e">token</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;PLUS&#34;</span>, <span style="color:#a6e22e">pattern</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;+&#34;</span>},
	{<span style="color:#a6e22e">token</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;ASTERISK&#34;</span>, <span style="color:#a6e22e">pattern</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;*&#34;</span>},
	{<span style="color:#a6e22e">token</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;LPAREN&#34;</span>, <span style="color:#a6e22e">pattern</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;(&#34;</span>},
	{<span style="color:#a6e22e">token</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;RPAREN&#34;</span>, <span style="color:#a6e22e">pattern</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;)&#34;</span>},
	{<span style="color:#a6e22e">token</span>:<span style="color:#66d9ef">null</span>, <span style="color:#a6e22e">pattern</span><span style="color:#f92672">:</span><span style="color:#e6db74">/(\r\n|\r|\n)+/</span>},
	{<span style="color:#a6e22e">token</span>:<span style="color:#66d9ef">null</span>, <span style="color:#a6e22e">pattern</span><span style="color:#f92672">:</span><span style="color:#e6db74">/[ \f\t\v\u00a0\u1680\u180e\u2000-\u200a\u202f\u205f\u3000\ufeff]+/</span>},
	{<span style="color:#a6e22e">token</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;INVALID&#34;</span>, <span style="color:#a6e22e">pattern</span><span style="color:#f92672">:</span><span style="color:#e6db74">/./</span>},
];

<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">grammar</span>:<span style="color:#66d9ef">GrammarDefinition</span> <span style="color:#f92672">=</span> {
	<span style="color:#a6e22e">lex</span>: <span style="color:#66d9ef">lex</span>,
	<span style="color:#a6e22e">syntax</span>: <span style="color:#66d9ef">syntax</span>,
	<span style="color:#a6e22e">start_symbol</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;EXP&#34;</span>
};
</code></pre></div><p><code>9 + 11 * (2 + 1)</code>という式を解析するためには、以下のように実行します。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#66d9ef">new</span> <span style="color:#a6e22e">ParserGenerator</span>(<span style="color:#a6e22e">grammar</span>).<span style="color:#a6e22e">getParser</span>().<span style="color:#a6e22e">parse</span>(<span style="color:#e6db74">&#34;9 + 11 * (2 + 1)&#34;</span>);
</code></pre></div><p>すると、結果として以下のようなオブジェクトが得られます。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{<span style="color:#f92672">&#34;type&#34;</span>:<span style="color:#e6db74">&#34;EXP&#34;</span>,<span style="color:#f92672">&#34;value&#34;</span>:<span style="color:#66d9ef">null</span>,<span style="color:#f92672">&#34;children&#34;</span>:[
    {<span style="color:#f92672">&#34;type&#34;</span>:<span style="color:#e6db74">&#34;EXP&#34;</span>,<span style="color:#f92672">&#34;value&#34;</span>:<span style="color:#66d9ef">null</span>,<span style="color:#f92672">&#34;children&#34;</span>:[
    {<span style="color:#f92672">&#34;type&#34;</span>:<span style="color:#e6db74">&#34;TERM&#34;</span>,<span style="color:#f92672">&#34;value&#34;</span>:<span style="color:#66d9ef">null</span>,<span style="color:#f92672">&#34;children&#34;</span>:[
        {<span style="color:#f92672">&#34;type&#34;</span>:<span style="color:#e6db74">&#34;ATOM&#34;</span>,<span style="color:#f92672">&#34;value&#34;</span>:<span style="color:#66d9ef">null</span>,<span style="color:#f92672">&#34;children&#34;</span>:[
                {<span style="color:#f92672">&#34;type&#34;</span>:<span style="color:#e6db74">&#34;DIGITS&#34;</span>,<span style="color:#f92672">&#34;value&#34;</span>:<span style="color:#e6db74">&#34;9&#34;</span>,<span style="color:#f92672">&#34;children&#34;</span>:[]}
            ]}
        ]}
    ]},
    {<span style="color:#f92672">&#34;type&#34;</span>:<span style="color:#e6db74">&#34;PLUS&#34;</span>,<span style="color:#f92672">&#34;value&#34;</span>:<span style="color:#e6db74">&#34;+&#34;</span>,<span style="color:#f92672">&#34;children&#34;</span>:[]},
    {<span style="color:#f92672">&#34;type&#34;</span>:<span style="color:#e6db74">&#34;TERM&#34;</span>,<span style="color:#f92672">&#34;value&#34;</span>:<span style="color:#66d9ef">null</span>,<span style="color:#f92672">&#34;children&#34;</span>:[
        {<span style="color:#f92672">&#34;type&#34;</span>:<span style="color:#e6db74">&#34;TERM&#34;</span>,<span style="color:#f92672">&#34;value&#34;</span>:<span style="color:#66d9ef">null</span>,<span style="color:#f92672">&#34;children&#34;</span>:[
            {<span style="color:#f92672">&#34;type&#34;</span>:<span style="color:#e6db74">&#34;ATOM&#34;</span>,<span style="color:#f92672">&#34;value&#34;</span>:<span style="color:#66d9ef">null</span>,<span style="color:#f92672">&#34;children&#34;</span>:[
                {<span style="color:#f92672">&#34;type&#34;</span>:<span style="color:#e6db74">&#34;DIGITS&#34;</span>,<span style="color:#f92672">&#34;value&#34;</span>:<span style="color:#e6db74">&#34;11&#34;</span>,<span style="color:#f92672">&#34;children&#34;</span>:[]}
            ]}
        ]},
        {<span style="color:#f92672">&#34;type&#34;</span>:<span style="color:#e6db74">&#34;ASTERISK&#34;</span>,<span style="color:#f92672">&#34;value&#34;</span>:<span style="color:#e6db74">&#34;*&#34;</span>,<span style="color:#f92672">&#34;children&#34;</span>:[]},
        {<span style="color:#f92672">&#34;type&#34;</span>:<span style="color:#e6db74">&#34;ATOM&#34;</span>,<span style="color:#f92672">&#34;value&#34;</span>:<span style="color:#66d9ef">null</span>,<span style="color:#f92672">&#34;children&#34;</span>:[
            {<span style="color:#f92672">&#34;type&#34;</span>:<span style="color:#e6db74">&#34;LPAREN&#34;</span>,<span style="color:#f92672">&#34;value&#34;</span>:<span style="color:#e6db74">&#34;(&#34;</span>,<span style="color:#f92672">&#34;children&#34;</span>:[]},
            {<span style="color:#f92672">&#34;type&#34;</span>:<span style="color:#e6db74">&#34;EXP&#34;</span>,<span style="color:#f92672">&#34;value&#34;</span>:<span style="color:#66d9ef">null</span>,<span style="color:#f92672">&#34;children&#34;</span>:[
                {<span style="color:#f92672">&#34;type&#34;</span>:<span style="color:#e6db74">&#34;EXP&#34;</span>,<span style="color:#f92672">&#34;value&#34;</span>:<span style="color:#66d9ef">null</span>,<span style="color:#f92672">&#34;children&#34;</span>:[
                    {<span style="color:#f92672">&#34;type&#34;</span>:<span style="color:#e6db74">&#34;TERM&#34;</span>,<span style="color:#f92672">&#34;value&#34;</span>:<span style="color:#66d9ef">null</span>,<span style="color:#f92672">&#34;children&#34;</span>:[
                        {<span style="color:#f92672">&#34;type&#34;</span>:<span style="color:#e6db74">&#34;ATOM&#34;</span>,<span style="color:#f92672">&#34;value&#34;</span>:<span style="color:#66d9ef">null</span>,<span style="color:#f92672">&#34;children&#34;</span>:[
                            {<span style="color:#f92672">&#34;type&#34;</span>:<span style="color:#e6db74">&#34;DIGITS&#34;</span>,<span style="color:#f92672">&#34;value&#34;</span>:<span style="color:#e6db74">&#34;2&#34;</span>,<span style="color:#f92672">&#34;children&#34;</span>:[]}
                        ]}
                    ]}
                ]},
                {<span style="color:#f92672">&#34;type&#34;</span>:<span style="color:#e6db74">&#34;PLUS&#34;</span>,<span style="color:#f92672">&#34;value&#34;</span>:<span style="color:#e6db74">&#34;+&#34;</span>,<span style="color:#f92672">&#34;children&#34;</span>:[]},
                {<span style="color:#f92672">&#34;type&#34;</span>:<span style="color:#e6db74">&#34;TERM&#34;</span>,<span style="color:#f92672">&#34;value&#34;</span>:<span style="color:#66d9ef">null</span>,<span style="color:#f92672">&#34;children&#34;</span>:[
                    {<span style="color:#f92672">&#34;type&#34;</span>:<span style="color:#e6db74">&#34;ATOM&#34;</span>,<span style="color:#f92672">&#34;value&#34;</span>:<span style="color:#66d9ef">null</span>,<span style="color:#f92672">&#34;children&#34;</span>:[
                        {<span style="color:#f92672">&#34;type&#34;</span>:<span style="color:#e6db74">&#34;DIGITS&#34;</span>,<span style="color:#f92672">&#34;value&#34;</span>:<span style="color:#e6db74">&#34;1&#34;</span>,<span style="color:#f92672">&#34;children&#34;</span>:[]}
                    ]}
                ]}
            ]},
            {<span style="color:#f92672">&#34;type&#34;</span>:<span style="color:#e6db74">&#34;RPAREN&#34;</span>,<span style="color:#f92672">&#34;value&#34;</span>:<span style="color:#e6db74">&#34;)&#34;</span>,<span style="color:#f92672">&#34;children&#34;</span>:[]}
        ]}
    ]}
]}
</code></pre></div><p>どこからどう見ても成功ですね。
おめでとうございます。</p>
<h3 id="コールバックを利用して構文木のさらなる解析を行う">コールバックを利用して構文木のさらなる解析を行う</h3>
<p>ついに、本記事の目標である構文木の取得を達成しました。
あとはこれに適当な再帰的処理を挟めば、良い感じに数式処理ができるでしょう。</p>
<p>確かに一度構文木を生成してからそれを解析してもよいのですが、パーサに適当なコールバックを渡し、構文木を生成する代わりに数式処理を行ってしまうという手もあります。</p>
<p>先ほどのparsergenerator.tsに、以下のような定義が含まれていました。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">TerminalCallbackArg</span> {
        <span style="color:#a6e22e">token</span>: <span style="color:#66d9ef">string</span>;
        <span style="color:#a6e22e">value</span>: <span style="color:#66d9ef">string</span>;
        <span style="color:#a6e22e">terminal</span>: <span style="color:#66d9ef">true</span>;
}
<span style="color:#66d9ef">export</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">NonterminalCallbackArg</span> {
        <span style="color:#a6e22e">token</span>: <span style="color:#66d9ef">string</span>;
        <span style="color:#a6e22e">children</span>: <span style="color:#66d9ef">Array</span>&lt;<span style="color:#f92672">any</span>&gt;;
        <span style="color:#a6e22e">pattern</span>: <span style="color:#66d9ef">Array</span>&lt;<span style="color:#f92672">string</span>&gt;;
        <span style="color:#a6e22e">terminal</span>: <span style="color:#66d9ef">false</span>;
}
<span style="color:#66d9ef">export</span> <span style="color:#66d9ef">declare</span> <span style="color:#a6e22e">type</span> <span style="color:#a6e22e">ParserCallbackArg</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">TerminalCallbackArg</span> <span style="color:#f92672">|</span> <span style="color:#a6e22e">NonterminalCallbackArg</span>;
<span style="color:#66d9ef">export</span> <span style="color:#66d9ef">declare</span> <span style="color:#a6e22e">type</span> <span style="color:#a6e22e">ParserCallback</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">arg</span>: <span style="color:#66d9ef">ParserCallbackArg</span>) <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">any</span>;
</code></pre></div><p>Parserのコンストラクタ引数、ParserGeneratorのgetParserメソッドの引数、またはParserのparseメソッドの引数としてコールバックを与えると、reduce処理が行われた際にそれを呼び出すことができます。
処理するべきトークンが終端器号であった場合はそのトークンの種類と実際の入力が、非終端記号であった場合は対応する規則の情報、およびその子ノードの情報が引数として与えられます。</p>
<p>実際に、数式の処理を行うための関数を書いてみましょう。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">solve_terminal</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">arg</span>:<span style="color:#66d9ef">TerminalCallbackArg</span>)<span style="color:#f92672">=&gt;</span>{
	<span style="color:#66d9ef">switch</span>(<span style="color:#a6e22e">arg</span>.<span style="color:#a6e22e">token</span>){
		<span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#34;DIGITS&#34;</span><span style="color:#f92672">:</span>
			<span style="color:#66d9ef">return</span> <span style="color:#f92672">+</span><span style="color:#a6e22e">arg</span>.<span style="color:#a6e22e">value</span>;
		<span style="color:#66d9ef">default</span><span style="color:#f92672">:</span>
			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span>;
	}
}
<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">solve_nonterminal</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">arg</span>:<span style="color:#66d9ef">NonterminalCallbackArg</span>)<span style="color:#f92672">=&gt;</span>{
	<span style="color:#66d9ef">switch</span>(<span style="color:#a6e22e">arg</span>.<span style="color:#a6e22e">token</span>){
		<span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#34;EXP&#34;</span><span style="color:#f92672">:</span>
			<span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">arg</span>.<span style="color:#a6e22e">children</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>) <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">arg</span>.<span style="color:#a6e22e">children</span>[<span style="color:#ae81ff">0</span>];
			<span style="color:#66d9ef">else</span> <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">arg</span>.<span style="color:#a6e22e">children</span>[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">+</span> <span style="color:#a6e22e">arg</span>.<span style="color:#a6e22e">children</span>[<span style="color:#ae81ff">2</span>];
		<span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#34;TERM&#34;</span><span style="color:#f92672">:</span>
			<span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">arg</span>.<span style="color:#a6e22e">children</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>) <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">arg</span>.<span style="color:#a6e22e">children</span>[<span style="color:#ae81ff">0</span>];
			<span style="color:#66d9ef">else</span> <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">arg</span>.<span style="color:#a6e22e">children</span>[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">*</span> <span style="color:#a6e22e">arg</span>.<span style="color:#a6e22e">children</span>[<span style="color:#ae81ff">2</span>];
		<span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#34;ATOM&#34;</span><span style="color:#f92672">:</span>
			<span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">arg</span>.<span style="color:#a6e22e">children</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>) <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">arg</span>.<span style="color:#a6e22e">children</span>[<span style="color:#ae81ff">0</span>];
			<span style="color:#66d9ef">else</span> <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">arg</span>.<span style="color:#a6e22e">children</span>[<span style="color:#ae81ff">1</span>];
	}
}
<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">solve</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">arg</span>:<span style="color:#66d9ef">ParserCallbackArg</span>)<span style="color:#f92672">=&gt;</span>{
	<span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">arg</span>.<span style="color:#a6e22e">terminal</span>) <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">solve_terminal</span>(<span style="color:#a6e22e">arg</span>);
	<span style="color:#66d9ef">else</span> <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">solve_nonterminal</span>(<span style="color:#a6e22e">arg</span>);
}
</code></pre></div><p>これをもとに、以下のように実行します。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#66d9ef">new</span> <span style="color:#a6e22e">ParserGenerator</span>(<span style="color:#a6e22e">grammar</span>).<span style="color:#a6e22e">getParser</span>(<span style="color:#a6e22e">solve</span>).<span style="color:#a6e22e">parse</span>(<span style="color:#e6db74">&#34;9 + 11 * (2 + 1)&#34;</span>);
</code></pre></div><p>実行結果は、以下のようになります。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#ae81ff">42</span>
</code></pre></div><p>これにて、パーサジェネレータの実装および構文解析が完了しました。
ここまでお付き合いいただき、ありがとうございました。</p>
<p><a href="http://tatamo.81.la/blog/2016/12/22/lr-parser-generator-implementation/">第1回:かんたん構文解析入門</a><br>
<a href="http://tatamo.81.la/blog/2017/04/04/lr-parser-generator-implementation-05/">前回:LR(1)パーサジェネレータの実装</a></p>
        <p><a href="https://twitter.com/share" class="twitter-share-button"{count} data-via="__tatamo__">Tweet</a></p>
        <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
    </article>
    <nav class="article-nav-adjacent">
        <span class="article-link-next"><a href="http://tatamo.81.la/blog/2017/05/29/seccamp-2017-sheet/">&lt;- Newer: セキュリティキャンプ2017の応募用紙</a></span>
        <span class="article-link-border"></span>
        <span class="article-link-prev"><a href="http://tatamo.81.la/blog/2017/04/04/lr-parser-generator-implementation-05/">Older: LR(1)パーサジェネレータを自作して構文解析をする 第5回:LR(1)パーサジェネレータの実装 -&gt;</a></span>
    </nav>

    </div>
    <aside class="sidebar">
        <div class="sidebar-content">
            <section>
                <h2 class="panel-title">Recent Posts</h2>
                <ul>
                <li><a href="http://tatamo.81.la/blog/2020/08/31/shinsotu-2021/" class="list-group-item">就活の記録</a></li>
                <li><a href="http://tatamo.81.la/blog/2019/12/10/automation-games/" class="list-group-item">自動化というゲームジャンルの成立と変遷</a></li>
                <li><a href="http://tatamo.81.la/blog/2019/09/04/symphonic-rain/" class="list-group-item">シンフォニック=レインの紹介、またはファルシータ・フォーセットについての考察のようなもの</a></li>
                <li><a href="http://tatamo.81.la/blog/2018/12/07/atcoder-cli-tutorial/" class="list-group-item">atcoder-cli チュートリアル</a></li>
                <li><a href="http://tatamo.81.la/blog/2018/12/07/atcoder-cli-installation-guide/" class="list-group-item">atcoder-cli インストールガイド</a></li>
                <li><a href="http://tatamo.81.la/blog/2018/12/07/atcoder-cli/" class="list-group-item">コマンドラインツールatcoder-cliを公開しました</a></li>
                </ul>
            </section>
            
            <section>
                <h2 class="panel-title"><a href="http://tatamo.81.la/blog/categories/">Categories</a></h2>
                <ul>
                <li><a href="http://tatamo.81.la/blog/categories/dev">dev (19)</a></li>
                <li><a href="http://tatamo.81.la/blog/categories/diary">diary (7)</a></li>
                <li><a href="http://tatamo.81.la/blog/categories/game">game (7)</a></li>
                <li><a href="http://tatamo.81.la/blog/categories/info">info (1)</a></li>
                <li><a href="http://tatamo.81.la/blog/categories/pc">pc (2)</a></li>
                </ul>
            </section>
            <section>
                <h2 class="panel-title"><a href="http://tatamo.81.la/blog/tags/">Tags</a></h2>
                <ul>
                <li><a href="http://tatamo.81.la/blog/tags/arago">arago (2)</a></li>
                <li><a href="http://tatamo.81.la/blog/tags/atcoder">atcoder (3)</a></li>
                <li><a href="http://tatamo.81.la/blog/tags/atcoder-cli">atcoder-cli (3)</a></li>
                <li><a href="http://tatamo.81.la/blog/tags/austin">austin (1)</a></li>
                <li><a href="http://tatamo.81.la/blog/tags/automation">automation (1)</a></li>
                <li><a href="http://tatamo.81.la/blog/tags/blog">blog (5)</a></li>
                <li><a href="http://tatamo.81.la/blog/tags/competitive-programming">competitive-programming (6)</a></li>
                <li><a href="http://tatamo.81.la/blog/tags/contest">contest (1)</a></li>
                <li><a href="http://tatamo.81.la/blog/tags/css">css (1)</a></li>
                <li><a href="http://tatamo.81.la/blog/tags/deploybot">deploybot (1)</a></li>
                <li><a href="http://tatamo.81.la/blog/tags/dtp">dtp (1)</a></li>
                <li><a href="http://tatamo.81.la/blog/tags/freeciv">freeciv (6)</a></li>
                <li><a href="http://tatamo.81.la/blog/tags/freecivcalc">freecivcalc (1)</a></li>
                <li><a href="http://tatamo.81.la/blog/tags/generics">generics (1)</a></li>
                <li><a href="http://tatamo.81.la/blog/tags/github">github (1)</a></li>
                <li><a href="http://tatamo.81.la/blog/tags/highlightjs">highlightjs (2)</a></li>
                <li><a href="http://tatamo.81.la/blog/tags/homebuilt_pc">homebuilt_pc (1)</a></li>
                <li><a href="http://tatamo.81.la/blog/tags/html">html (1)</a></li>
                <li><a href="http://tatamo.81.la/blog/tags/hugo">hugo (2)</a></li>
                <li><a href="http://tatamo.81.la/blog/tags/icpc">icpc (1)</a></li>
                <li><a href="http://tatamo.81.la/blog/tags/info">info (1)</a></li>
                <li><a href="http://tatamo.81.la/blog/tags/isucon">isucon (2)</a></li>
                <li><a href="http://tatamo.81.la/blog/tags/japari-watch">japari-watch (1)</a></li>
                <li><a href="http://tatamo.81.la/blog/tags/java">java (1)</a></li>
                <li><a href="http://tatamo.81.la/blog/tags/javascript">javascript (5)</a></li>
                <li><a href="http://tatamo.81.la/blog/tags/lexer">lexer (6)</a></li>
                <li><a href="http://tatamo.81.la/blog/tags/parser">parser (6)</a></li>
                <li><a href="http://tatamo.81.la/blog/tags/parser-generator">parser-generator (6)</a></li>
                <li><a href="http://tatamo.81.la/blog/tags/parsing">parsing (6)</a></li>
                <li><a href="http://tatamo.81.la/blog/tags/pc">pc (1)</a></li>
                <li><a href="http://tatamo.81.la/blog/tags/pixijs">pixijs (1)</a></li>
                <li><a href="http://tatamo.81.la/blog/tags/reflection">reflection (1)</a></li>
                <li><a href="http://tatamo.81.la/blog/tags/seccamp">seccamp (2)</a></li>
                <li><a href="http://tatamo.81.la/blog/tags/shukatu">shukatu (1)</a></li>
                <li><a href="http://tatamo.81.la/blog/tags/symphonic-rain">symphonic-rain (1)</a></li>
                <li><a href="http://tatamo.81.la/blog/tags/vivliostyle">vivliostyle (1)</a></li>
                <li><a href="http://tatamo.81.la/blog/tags/wercker">wercker (1)</a></li>
                </ul>
            </section>
        </div>
    </aside>

    </div>
   <footer>
        <p>Copyright (c) 2015 <a href="about/">Tatamo</a>.</p>
        <p>Powered by <a href="http://gohugo.io" target="_blank">Hugo</a></p>
    </footer>
</body>
</html>

